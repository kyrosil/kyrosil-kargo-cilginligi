<!DOCTYPE html>
<html lang="tr"> {/* Lang özniteliğini Türkçe yaptım */}
<head>
  <meta charset="UTF-8">
  <title>Trendyol Kargo Kapmaca</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.4/p5.min.js"></script>
  <style>
    body { margin: 0; display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100vh; background-color: #f0f0f0; font-family: sans-serif; } /* Okunabilirlik için font ekledim */
    #gameCanvas { border: 2px solid #000; display: none; } /* Başlangıçta gizli */
    #startScreen { text-align: center; }
    #startScreen img { margin: 10px; width: 100px; vertical-align: middle;} /* Logoları ortalamak için */
    #startButton, #restartButton, #message { margin-top: 20px; padding: 12px 25px; font-size: 18px; } /* Buton ve mesaj stilini biraz iyileştirdim */
    #startButton, #restartButton { cursor: pointer; background-color: #ff6200; color: white; border: none; border-radius: 5px; }
    #restartButton { display: none; } /* Başlangıçta gizli */
    #message { color: red; display: none; font-weight: bold; }
    h2 { color: #333; }
    p { color: #555; }
  </style>
</head>
<body>
  <div id="gameCanvas"></div>

  <div id="startScreen">
    <img src="images.jpg" alt="Trendyol Logo">
    <img src="cropped-adsiz_tasarim-removebg-preview-1.png" alt="Kyrosil Logo">
    <h2>Trendyol Kargo Kapmaca</h2>
    <p>50 puana ulaş, <strong>50 TL Trendyol Hediye Çeki</strong> kazan!</p>
    <p>Günde 3 hakla oyna, 3 kargo kaçırırsan oyun biter!</p>
    <button id="startButton" onclick="startGame()">Başla</button>
  </div>

  <div id="message"></div>

  <button id="restartButton" onclick="restartGame()">Yeniden Başlat</button>

<script>
let gleen;
let kargolar = [];
let score = 0;
let misses = 0;
let giftMessage = '';
let gameOver = false;
let lives = 3; // Başlangıç değeri, checkLives ile güncellenecek
let trendyolLogo, kyrosilLogo;
// gameState değişkenine artık pek gerek yok ama isterseniz tutabilirsiniz.
// let gameState = 'startScreen'; // Başlangıç durumu

// p5.js canvas referansı için değişken
let gameInstanceCanvas;

function checkLives() {
  const today = new Date().toDateString();
  const storedDate = localStorage.getItem('gameDate');
  const storedLives = localStorage.getItem('lives'); // string olarak alıp kontrol edelim

  if (storedDate !== today || storedLives === null) {
    // Tarih farklıysa veya ilk defa oynanıyorsa hakları sıfırla
    console.log('Günlük haklar sıfırlandı.');
    localStorage.setItem('gameDate', today);
    localStorage.setItem('lives', '3'); // String olarak kaydedelim
    return 3;
  }
  const currentLives = parseInt(storedLives);
  console.log('Kaydedilmiş haklar:', currentLives);
  return isNaN(currentLives) ? 3 : currentLives; // Eğer sayı değilse 3 döndür
}

function updateStoredLives(newLives) {
    lives = newLives;
    localStorage.setItem('lives', lives.toString()); // String olarak kaydet
    console.log('Haklar güncellendi:', lives);
}

function preload() {
  try {
    // ÖNEMLİ: Dosya yollarının doğru olduğundan emin olun!
    // GitHub Pages'da ana dizindeyse '/images.jpg' veya sadece 'images.jpg' olabilir.
    // Eğer bir klasör içindeyse 'klasor_adi/images.jpg' gibi olmalı.
    trendyolLogo = loadImage('images.jpg');
    kyrosilLogo = loadImage('cropped-adsiz_tasarim-removebg-preview-1.png');
    console.log('Logolar yüklenmeye çalışıldı.');
  } catch (e) {
    console.error('Logo yükleme hatası:', e);
    // Hata durumunda logolar null olacak, draw içinde kontrol ediliyor.
    trendyolLogo = null;
    kyrosilLogo = null;
  }
}

function setup() {
  // Canvas oluştur ve gameCanvas div'ine yerleştir
  gameInstanceCanvas = createCanvas(800, 600);
  gameInstanceCanvas.parent('gameCanvas');

  // Başlangıç eleman pozisyonu
  gleen = { x: width / 2 - 25, y: height - 50, w: 50, h: 50 }; // Ortalamak için -25 ekledim

  // Başlangıçta hakları kontrol et
  lives = checkLives();
  console.log('Setup: Mevcut haklar:', lives);

  // Oyun döngüsünü başlangıçta durdur
  noLoop();
  console.log('Setup tamamlandı, oyun başlamayı bekliyor.');
}

// Oyun değişkenlerini sıfırlama fonksiyonu
function resetGame() {
    score = 0;
    misses = 0;
    kargolar = [];
    giftMessage = '';
    gameOver = false;
    gleen.x = width / 2 - gleen.w / 2; // Sepeti ortaya al
    document.getElementById('message').style.display = 'none'; // Mesajları gizle
    document.getElementById('restartButton').style.display = 'none'; // Yeniden başlat butonunu gizle
    console.log("Oyun değişkenleri sıfırlandı.");
}

function draw() {
  // Arka planı temizle
  background(220);

  // Oyun bittiyse
  if (gameOver) {
    fill(255, 0, 0);
    textSize(40);
    textAlign(CENTER, CENTER); // Hem yatay hem dikey ortala
    text('Oyun Bitti! Puan: ' + score, width / 2, height / 2 - 40); // Mesajı biraz yukarı aldım

    if (lives > 0) {
      document.getElementById('restartButton').style.display = 'block'; // Yeniden başlat butonu göster
       text('Tekrar denemek için 1 hakkını kullan.', width / 2, height / 2 + 20); // Ek bilgi
    } else {
      document.getElementById('message').style.display = 'block';
      document.getElementById('message').innerText = 'Günlük 3 hakkın bitti! Yarın tekrar dene.';
      document.getElementById('restartButton').style.display = 'none'; // Butonu gizle
    }
    noLoop(); // Oyun bittiğinde döngüyü durdur
    console.log('Oyun bitti, puan:', score, 'Kalan Haklar:', lives);
    return; // Draw fonksiyonundan çık
  }

  // --- Oyun Aktif Durumda ---

  // Sepeti (gleen) çiz
  fill(0, 0, 255);
  rect(gleen.x, gleen.y, gleen.w, gleen.h);

  // Sepeti fare ile hareket ettir ve canvas sınırları içinde tut
  gleen.x = mouseX - gleen.w / 2;
  if (gleen.x < 0) gleen.x = 0;
  if (gleen.x > width - gleen.w) gleen.x = width - gleen.w;

  // Belirli aralıklarla yeni kargo ekle (hak varsa)
  // frameCount: p5.js'nin başlangıcından beri geçen kare sayısı
  if (frameCount % 60 === 0 && lives > 0) { // Saniyede 1 kargo (yaklaşık)
    let isBonus = random(1) < 0.15; // %15 ihtimalle bonus kargo
    kargolar.push({
      x: random(width - 30), // Kargoların canvas dışına taşmamasını sağla
      y: -30, // Yukarıdan başlasın
      w: 30,
      h: 30,
      speed: random(4, 8),
      isBonus: isBonus
    });
    // console.log('Yeni kargo eklendi, bonus:', isBonus); // Çok fazla log olmaması için kapattım
  }

  // Kargoları yönet
  for (let i = kargolar.length - 1; i >= 0; i--) {
    let kargo = kargolar[i];

    // Kargoyu hareket ettir
    kargo.y += kargo.speed;

    // Kargoyu çiz (logo varsa logo, yoksa renkli kare)
    if (kargo.isBonus && kyrosilLogo) {
      image(kyrosilLogo, kargo.x, kargo.y, kargo.w, kargo.h);
    } else if (!kargo.isBonus && trendyolLogo) {
      image(trendyolLogo, kargo.x, kargo.y, kargo.w, kargo.h);
    } else {
      // Logo yüklenememişse veya beklenmedik bir durum varsa
      fill(kargo.isBonus ? color(255, 215, 0) : color(139, 69, 19)); // Altın sarısı / Kahverengi
      rect(kargo.x, kargo.y, kargo.w, kargo.h);
    }

    // Çarpışma kontrolü (sepet kargoyu yakaladı mı?)
    if (
      gleen.x < kargo.x + kargo.w &&
      gleen.x + gleen.w > kargo.x &&
      gleen.y < kargo.y + kargo.h &&
      gleen.y + gleen.h > kargo.y
    ) {
      score += kargo.isBonus ? 5 : 1; // Bonussa 5, değilse 1 puan
      kargolar.splice(i, 1); // Kargoyu listeden sil
      console.log('Kargo yakalandı, puan:', score);
      if (score >= 50 && !giftMessage) { // Mesaj henüz ayarlanmamışsa ayarla
        giftMessage = 'Tebrikler! 50 TL Trendyol Hediye Çeki Kazandın!';
        console.log('Hediye çeki kazanıldı!');
        // İsterseniz burada oyunu durdurabilir veya farklı bir mesaj gösterebilirsiniz.
        // Örneğin: gameOver = true; noLoop();
      }
    }
    // Kargo ekran dışına çıktı mı? (Kaçırıldı)
    else if (kargo.y > height) {
      kargolar.splice(i, 1); // Kargoyu listeden sil
      if (!kargo.isBonus) { // Sadece normal kargolar kaçırılınca say
          misses += 1;
          console.log('Kargo kaçırıldı, kaçırılan:', misses);
          if (misses >= 3) {
            gameOver = true;
            updateStoredLives(lives - 1); // Hakkı azalt ve kaydet
            // updateLives() çağrısına gerek yok, gameOver zaten draw'ı durduracak
          }
      } else {
          console.log('Bonus kargo kaçırıldı (hak eksilmedi).');
      }
    }
  }

  // Bilgileri ekrana yazdır
  fill(0);
  textSize(20);
  textAlign(LEFT, TOP); // Hizalamayı sola ve üste göre yap
  text('Puan: ' + score, 10, 20);
  text('Kaçırılan: ' + misses + '/3', 10, 50);
  text('Kalan Hak: ' + lives, 10, 80); // Güncel hak sayısını göster

  // Hediye mesajı varsa göster
  if (giftMessage) {
    textAlign(CENTER, CENTER);
    textSize(24);
    fill(0, 150, 0); // Yeşil renk
    text(giftMessage, width / 2, height / 2);
  }
}

// Oyunu Başlatma Fonksiyonu
function startGame() {
  lives = checkLives(); // Başlarken hakları tekrar kontrol et
  if (lives > 0) {
    document.getElementById('startScreen').style.display = 'none'; // Başlangıç ekranını gizle
    document.getElementById('gameCanvas').style.display = 'block'; // Oyun alanını göster
    resetGame(); // Oyun değişkenlerini sıfırla
    // gameState = 'playing'; // Durumu ayarla (isteğe bağlı)
    loop(); // p5.js draw döngüsünü başlat
    console.log('Oyun başlatıldı, haklar:', lives);
  } else {
    document.getElementById('message').style.display = 'block';
    document.getElementById('message').innerText = 'Günlük 3 hakkın bitti! Yarın tekrar dene.';
    console.log('Haklar bitti, oyun başlatılamadı');
  }
}

// Oyunu Yeniden Başlatma Fonksiyonu
function restartGame() {
  // Yeniden başlatma bir hakka mal olmalı
  if (lives > 0) {
     updateStoredLives(lives - 1); // Hakkı azalt ve kaydet
     if (lives > 0) { // Hala hakkı varsa oyunu sıfırla ve başlat
        resetGame();
        // gameState = 'playing'; // Durumu ayarla (isteğe bağlı)
        loop(); // p5.js draw döngüsünü başlat
        console.log('Oyun yeniden başlatıldı, kalan haklar:', lives);
     } else { // Son hak kullanıldıysa
        gameOver = true; // Oyun bitti durumuna geç
        draw(); // Game over ekranını çizdirmek için draw'ı bir kereliğine çağır
        console.log('Son hak kullanıldı, oyun bitti.');
     }
  } else {
      console.log('Yeniden başlatılamadı, haklar bitti');
      // Normalde bu butona tıklanamaması lazım ama ek kontrol
      document.getElementById('restartButton').style.display = 'none';
  }
}

</script>
</body>
</html>
